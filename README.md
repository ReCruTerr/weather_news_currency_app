# API Gateway на FastAPI

## Описание проекта

Этот проект представляет собой API Gateway, разработанный на основе фреймворка **FastAPI**, который объединяет данные из нескольких внешних API (погода, новости, курсы валют, пробки и т.д.) под единым интерфейсом. Вместо того чтобы фронтенду делать 5-6 запросов к разным API, достаточно одного запроса к нашему сервису. Внутренне сервис выполняет параллельные асинхронные запросы к внешним источникам, применяет кэширование, ограничивает частоту запросов, обрабатывает ошибки и нормализует данные в единый формат.

### Концепция
- **Агрегация данных**: Единый эндпоинт собирает данные из разных внешних API.
- **Оптимизация**: Снижение количества запросов с фронтенда за счет параллельных вызовов и кэширования.
- **Устойчивость**: Использование Circuit Breaker для обработки недоступности внешних сервисов.
- **Мониторинг**: Встроенные health checks и логирование.

## Ключевые функции
- Асинхронные запросы с использованием `aiohttp`.
- Кэширование результатов в Redis с настройкой TTL.
- Ограничение частоты запросов (Rate Limiting) для клиентов и внешних API.
- Паттерн Circuit Breaker для защиты от сбоев внешних сервисов.
- Трансформация и нормализация данных из разных источников.
- Мониторинг состояния через health check эндпоинты.
- Единый формат ответов и обработка ошибок.
- Автоматическая документация API через OpenAPI/Swagger.

## Технический стек
- **FastAPI + Pydantic + uvicorn**: Основной фреймворк и сервер.
- **aiohttp + aioredis**: Асинхронные операции с HTTP и Redis.
- **Redis**: Кэширование и хранение состояния Circuit Breaker.
- **pytest**: Тестирование кода.
- **Docker**: Контейнеризация приложения.

## Установка и запуск

### Предварительные требования
- Python 3.9+
- Redis-сервер (установить через `choco install redis-64` на Windows или `apt install redis-server` на Linux)
- Docker (опционально для контейнеризации)

### Установка зависимостей
1. Клонируйте репозиторий:
   ```
   git clone https://github.com/your-username/api-gateway.git
   cd api-gateway
   ```
2. Создайте виртуальную среду и активируйте ее:
   ```
   python -m venv myenv
   source myenv/bin/activate  # На Linux/Mac
   myenv\Scripts\activate     # На Windows
   ```
3. Установите зависимости:
   ```
   pip install -r requirements.txt
   ```

### Настройка
1. Создайте файл `.env` на основе `env.example` (если предоставлен) или настрой переменные окружения:
   - `REDIS_HOST=localhost`
   - `REDIS_PORT=6379`
   - `REDIS_DB=0`
   - `CACHE_TTL=300` (TTL в секундах)

2. Запустите Redis-сервер:
   ```
   redis-server
   ```

### Запуск приложения
1. Запустите сервер с помощью Uvicorn:
   ```
   uvicorn app.main:app --reload --host localhost --port 8000
   ```
2. Откройте Swagger UI для документации: [http://localhost:8000/docs](http://localhost:8000/docs)

### Запуск в Docker
1. Постройте образ:
   ```
   docker build -t api-gateway .
   ```
2. Запустите контейнер:
   ```
   docker run -p 8000:8000 -e REDIS_HOST=host.docker.internal api-gateway
   ```

## Примеры эндпоинтов
- **GET /api/v1/city/{city}/dashboard**: Агрегированная сводка по городу (погода, новости, пробки и т.д.).
  - Пример: `GET /api/v1/city/Moscow/dashboard`
- **GET /api/v1/user/{user_id}/summary**: Персонализированные данные для пользователя.
  - Пример: `GET /api/v1/user/123/summary`
- **GET /api/v1/status**: Состояние всех интеграций (health check).
  - Пример: `GET /api/v1/status`
- **GET /api/v1/providers/health**: Состояние внешних API.
  - Пример: `GET /api/v1/providers/health`

## Структура проекта
```
api-gateway/
├── app/
│   ├── api/           # Эндпоинты API
│   ├── core/          # Логика кэширования, Circuit Breaker, клиенты
│   ├── models/        # Схемы Pydantic
│   └── main.py        # Входная точка приложения
├── tests/             # Тесты
├── requirements.txt   # Зависимости
├── Dockerfile         # Конфигурация Docker
└── README.md          # Этот файл
```

## Разработка и тестирование
- Используйте `pytest` для запуска тестов:
  ```
  pytest tests/
  ```
- Для добавления новых функций следуйте принципу расширения эндпоинтов и интеграции внешних API через `core/clients`.
